<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>In-browser NES .asm → .nes Assembler</title>
<style>
body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;background:#0b1020;color:#e6eef8;padding:18px}
h1{margin:0 0 8px}
textarea{width:100%;height:320px;font-family:monospace;margin-bottom:8px;background:#071020;color:#cfe7ff;padding:8px;border:1px solid #1b2b3b}
.row{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap;}
button{padding:8px 12px;border-radius:6px;border:0;background:#0f6;cursor:pointer}
button.ghost{background:#1b2b3b;color:#cfe7ff;text-decoration:none;display:inline-flex;align-items:center;justify-content:center}
a[aria-disabled="true"]{pointer-events:none;opacity:0.5;}
pre{background:#071020;padding:12px;border-radius:6px;overflow:auto;border:1px solid #112233;white-space:pre-wrap;}
label{display:block;margin-bottom:6px}
.small{font-size:0.9rem;color:#9fb6d9}
input[type="number"]{width:120px;padding:6px}
</style>
</head>
<body>
<h1>NES .asm → .nes (in-browser)</h1>
<div class="small">Paste 6502-style NES assembly, use <code>.org $8000</code> (default $8000), then Assemble → Download .nes</div>

<label>Assembly source</label>
<textarea id="asm" spellcheck="false">; Example: a tiny NES program (infinite loop)
.org $8000
start:  SEI
        CLD
        LDX #$FF
        TXS
loop:   NOP
        JMP loop
.org $FFFA
.word 0 ; NMI vector
.word 0 ; RESET vector (filled later)
.word 0 ; IRQ/BRK vector
</textarea>

<div class="row">
  <button id="assemble">Assemble & Build .nes</button>
  <a class="ghost" id="download" aria-disabled="true">Download .nes</a>
  <div style="display:flex;align-items:center;gap:8px">
    <label class="small">PRG size (16KB banks):
      <input type="number" id="prgBanks" min="1" value="1"/>
    </label>
  </div>
</div>

<label>Assembly log / errors</label>
<pre id="log"></pre>

<script>
(function(){
  const txtIn = document.getElementById('asm');
  const log = document.getElementById('log');
  const assembleBtn = document.getElementById('assemble');
  const downloadBtn = document.getElementById('download');
  const prgBanksInput = document.getElementById('prgBanks');
  const chrBanksInput = document.getElementById('chrBanks');

  function hex(n,len=2){let s=(n>>>0).toString(16).toUpperCase(); while(s.length<len)s='0'+s; return '$'+s;}
  function parseNumber(tok){if(!tok)return null; tok=tok.trim(); if(tok.startsWith('$')) return parseInt(tok.slice(1),16); if(tok.startsWith('%')) return parseInt(tok.slice(1),2); if(tok.startsWith('0x')) return parseInt(tok.slice(2),16); if(/^[-+]?\d+$/.test(tok)) return parseInt(tok,10); return null;}
  function stripComments(line){let i=line.indexOf(';');if(i>=0)return line.slice(0,i);i=line.indexOf('//');if(i>=0)return line.slice(0,i);return line;}
  function parseOperandMode(op){
    if(!op||op.trim()==='') return {mode:'impl',value:null};
    op=op.trim();
    if(/^A$/i.test(op)) return {mode:'acc',value:null};
    if(op.startsWith('#')) return {mode:'imm',value:op.slice(1).trim()};
    let m1=op.match(/^\(\s*([^)]+?)\s*,\s*[Xx]\s*\)$/); if(m1) return {mode:'indx',value:m1[1].trim()};
    let m2=op.match(/^\(\s*([^)]+?)\s*\)\s*,\s*[Yy]$/); if(m2) return {mode:'indy',value:m2[1].trim()};
    let m3=op.match(/^\(\s*([^)]+?)\s*\)$/); if(m3) return {mode:'ind',value:m3[1].trim()};
    let m4=op.match(/^(.+?)\s*,\s*([XxYy])$/); if(m4){ let reg=m4[2].toUpperCase(); return {mode:reg==='X'?'absx':'absy',value:m4[1].trim()}; }
    return {mode:'addr',value:op};
  }

  // (OPCODES table unchanged...)

  function assemble(src,options){
    const lines=src.split(/\r?\n/);
    const cleanLines=lines.map((l,i)=>({orig:l,text:stripComments(l).trim(),lineno:i+1}));
    let org=0x8000, pc=org, symbols={}, output=[], errors=[];

    for(let pass=1;pass<=2;pass++){
      pc=org; output=[];
      if(pass===2) log.textContent+='\n--- PASS 2 ---\n';
      for(const ln of cleanLines){
        let line=ln.text;
        if(line===''){ output.push({addr:pc,bytes:[],src:ln}); continue; }
        if(/^[A-Za-z_][\w]*:$/.test(line)){ if(pass===1) symbols[line.replace(/:$/,'')]=pc; output.push({addr:pc,bytes:[],src:ln}); continue; }
        if(/^[A-Za-z_][\w]*:\s+/.test(line)){
          let m=line.match(/^([A-Za-z_][\w]*):\s*(.*)$/);
          if(m){ if(pass===1) symbols[m[1]]=pc; line=m[2]; }
        }
        if(line.startsWith('.')){
          let dir=line.split(/\s+/)[0].toLowerCase();
          if(dir==='.org'){ let n=parseNumber(line.substring(dir.length).trim()); if(n!=null) org=pc=n; output.push({addr:pc,bytes:[],src:ln}); continue; }
          if(dir==='.byte'||dir==='.db'){
            let items=line.substring(dir.length).trim().split(',').map(s=>s.trim()).filter(Boolean);
            if(pass===1){pc+=items.length; output.push({addr:pc-items.length,bytes:[],src:ln}); continue;}
            let bytes=[];
            for(const it of items){
              let v=parseNumber(it); if(v==null){if(it in symbols)v=symbols[it];else{errors.push(`Line ${ln.lineno}: unknown symbol ${it}`);v=0;} } 
              bytes.push(v&0xFF);
            }
            output.push({addr:pc,bytes:bytes,src:ln}); pc+=bytes.length; continue;
          }
          if(dir==='.word'){
            let items=line.substring(dir.length).trim().split(',').map(s=>s.trim()).filter(Boolean);
            if(pass===1){pc+=items.length*2; output.push({addr:pc-items.length*2,bytes:[],src:ln}); continue;}
            let bytes=[];
            for(const it of items){ let v=parseNumber(it); if(v==null){ if(it in symbols)v=symbols[it]; else{errors.push(`Line ${ln.lineno}: unknown word ${it}`); v=0;} } bytes.push(v&0xFF); bytes.push((v>>8)&0xFF); }
            output.push({addr:pc,bytes:bytes,src:ln}); pc+=bytes.length; continue;
          }
        }
        // (instruction parsing unchanged...)
      }
    }

    // Build PRG ROM
    let PRG_BANK_SIZE=16384;
    let CHR_BANK_SIZE=8192;
    let minAddr=Math.min(...output.filter(s=>s.bytes.length).map(s=>s.addr));
    let maxAddr=Math.max(...output.filter(s=>s.bytes.length).map(s=>s.addr+s.bytes.length-1));
    let neededBytes=maxAddr-0x8000+1;
    let prgBanks=Math.max(options.prgBanks,Math.ceil(neededBytes/PRG_BANK_SIZE));
    let prg=new Uint8Array(prgBanks*PRG_BANK_SIZE).fill(0x00);

    for(const s of output){ if(s.bytes.length){ let off=s.addr-0x8000; if(off<0){errors.push(`Address below $8000`); continue;} prg.set(s.bytes,off); }}

    // Patch reset vector at $FFFC
    let resetOffset=0xFFFC-0x8000; if(resetOffset>=0&&resetOffset+1<prg.length){ prg[resetOffset]=0x00; prg[resetOffset+1]=0x80; }

    // Build CHR ROM (all zeros)
    let chrBanks=Math.max(0,options.chrBanks||0);
    let chr=new Uint8Array(chrBanks*CHR_BANK_SIZE).fill(0x00);

    // iNES header
    let header=new Uint8Array(16);
    header[0]=0x4E; header[1]=0x45; header[2]=0x53; header[3]=0x1A;
    header[4]=prgBanks;
    header[5]=chrBanks;  // CHR-ROM size in 8KB units
    header[6]=0; header[7]=0;

    let rom=new Uint8Array(header.length + prg.length + chr.length);
    rom.set(header,0);
    rom.set(prg,header.length);
    rom.set(chr,header.length + prg.length);

    return {rom,errors,symbols,prgBanks,prgSize:prg.length,chrBanks,chrSize:chr.length,output};
  }

  assembleBtn.addEventListener('click',()=>{
    log.textContent=''; 
    downloadBtn.setAttribute('aria-disabled','true'); 
    downloadBtn.removeAttribute('href'); 
    downloadBtn.removeAttribute('download');

    const src=txtIn.value;
    const prgBanks=Math.max(1,parseInt(prgBanksInput.value)||1);
    const chrBanks=Math.max(0,parseInt(chrBanksInput.value)||0);
    const res=assemble(src,{prgBanks,chrBanks});

    if(res.errors.length>0){ log.textContent+='Errors / Warnings:\n'+res.errors.join('\n')+'\n\n'; } 
    else { log.textContent+='Assembled successfully.\n'; }
    log.textContent+=`\nPRG banks: ${res.prgBanks}, PRG size: ${res.prgSize} bytes\nCHR banks: ${res.chrBanks}, CHR size: ${res.chrSize} bytes\nSymbols:\n`;
    for(const s in res.symbols) log.textContent+=`  ${s} = ${hex(res.symbols[s],4)}\n`;

    const blob=new Blob([res.rom],{type:'application/octet-stream'});
    const url=URL.createObjectURL(blob);
    downloadBtn.href=url;
    downloadBtn.download='output.nes';
    downloadBtn.setAttribute('aria-disabled','false');
    downloadBtn.dataset.url=url;
  });

  downloadBtn.addEventListener('click',()=>{
    setTimeout(()=>{ if(downloadBtn.dataset.url){ URL.revokeObjectURL(downloadBtn.dataset.url); delete downloadBtn.dataset.url; } },2000);
  });
})();
</script>
</body>
</html>
