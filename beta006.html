<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LemonNES Beta v0.0.6</title>
  <style>
    :root { --bg:#0b0f14; --fg:#e8f0ff; --muted:#8aa0b6; --acc:#73d7ff; --card:#121926; }
    html,body{
      height:100%; margin:0; background:var(--bg); color:var(--fg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      /* --- Prevent scroll --- */
      overflow-x: hidden;
      overflow-y: hidden;
      touch-action: none;
    }
    body {
      min-height: 100vh;
      min-width: 100vw;
    }
    .wrap{display:grid; grid-template-columns: 1fr 340px; gap:16px; padding:16px; box-sizing:border-box;}
    header{grid-column: 1 / -1; display:flex; align-items:center; justify-content:space-between}
    header h1{font-size:18px; margin:0; font-weight:600}
    header .sub{color:var(--muted); font-size:12px}
    .screen{background:#000; padding:8px; border-radius:16px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:flex; align-items:center; justify-content:center;}
    canvas{image-rendering: pixelated; image-rendering: crisp-edges; border-radius:12px; background:#000; touch-action:none;}
    .side{background:var(--card); border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:12px;}
    .row{display:flex; align-items:center; gap:10px;}
    .row + .row{margin-top:10px}
    label{font-size:12px; color:var(--muted)}
    .stat{font:12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono"; color:#99b3cc}
    button, input[type="file"]::file-selector-button{background:#1a2433; color:var(--fg); border:1px solid rgba(255,255,255,.08); padding:8px 10px; border-radius:12px; cursor:pointer}
    button:disabled{opacity:.5; cursor:not-allowed}
    .kbd{display:inline-block; padding:.1rem .4rem; border-radius:6px; background:#0e1624; border:1px solid rgba(255,255,255,.05); font:11px ui-monospace}
    details{margin-top:10px}
    summary{cursor:pointer; color:var(--acc)}
    ul{margin:.25rem 0 .5rem 1.25rem}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:6px}
    /* Mobile controls overlay */
    .mobile-controls {
      display: none;
      position: fixed;
      left: 0; right: 0; bottom: 0;
      z-index: 1000;
      pointer-events:none;
    }
    .mobile-controls.active {
      display: flex;
      pointer-events: auto;
      flex-direction: row;
      justify-content: space-between;
      width: 100vw;
      padding: 0 2vw 2vw 2vw;
      box-sizing: border-box;
      user-select: none;
    }
    .dpad, .abpad {
      display: grid;
      grid-template-columns: repeat(3, 44px);
      grid-template-rows: repeat(3, 44px);
      gap: 4px;
    }
    .abpad {
      grid-template-columns: 44px 44px;
      grid-template-rows: 44px 44px;
      gap: 16px;
      align-self: flex-end;
    }
    .mobile-btn {
      background:rgba(60,90,200,0.28); border:1px solid #567; border-radius:16px; color:#e0e8ff;
      font-size:18px; font-family: ui-monospace; width:44px; height:44px; display:flex; align-items:center; justify-content:center;
      opacity:.92; transition:background .1s; touch-action:none;
      pointer-events: auto;
      user-select: none;
    }
    .mobile-btn:active, .mobile-btn.pressed {
      background:rgba(80,180,255,0.55);
      color:#000;
    }
    /* Overlay mask for hiding mobile controls */
    .mobile-controls-overlay-mask {
      position: fixed;
      left: 0; right: 0; top: 0; bottom: 0;
      background: rgba(15,22,32,0.92);
      z-index: 1001;
      display: none;
      pointer-events: auto;
      transition: opacity 0.2s;
    }
    .mobile-controls-overlay-mask.active {
      display: block;
      /* Optional: fade-in effect */
      animation: mask-fade-in 0.15s;
    }
    @keyframes mask-fade-in {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    /* Hide overlay button */
    .hide-mobile-btn {
      position: absolute;
      right: 14px;
      top: 14px;
      z-index: 1002;
      background: #1a2433;
      color: var(--fg);
      border: 1px solid rgba(255,255,255,0.18);
      padding: 8px 14px;
      border-radius: 14px;
      font-size: 15px;
      font-family: ui-monospace;
      opacity: 0.92;
      cursor: pointer;
      box-shadow: 0 2px 8px #0006;
      user-select: none;
      pointer-events: auto;
      transition: background .15s, color .15s;
    }
    .hide-mobile-btn:active {
      background: #39495f;
      color: var(--acc);
    }
    /* Show overlay button for bringing controls back */
    .show-mobile-btn {
      position: fixed;
      right: 16px;
      bottom: 88px;
      z-index: 1003;
      background: #121926;
      color: var(--acc);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 10px 16px;
      border-radius: 14px;
      font-size: 15px;
      font-family: ui-monospace;
      opacity: 0.81;
      cursor: pointer;
      box-shadow: 0 2px 8px #0007;
      user-select: none;
      display: none;
      pointer-events: auto;
      transition: background .15s, color .15s;
    }
    .show-mobile-btn.active {
      display: block;
      animation: mask-fade-in 0.15s;
    }
    @media (max-width: 900px) {
      html,body {
        overflow-x: hidden;
        overflow-y: hidden;
        touch-action: none;
      }
      .wrap { display: block; padding: 2vw; }
      .side { margin-top: 20px; }
      .screen { justify-content: center; }
      canvas { width: 98vw !important; height: auto !important; max-width: 100vw; max-height: 70vw; }
      .mobile-controls { display: flex !important; }
    }
    @media (pointer: coarse) {
      .mobile-controls { display: flex !important; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>LemonNES Beta v0.0.6 <span class="sub">- Should Load Early ROMs And Simple Homebrew</span></h1>
        <div class="sub">Cycle-stepped PPU (scanline/dot), sprite pipeline w/ sprite-0 hit, simple APU, and baseline common mappers.</div>
      </div>
      <div class="stat" id="build"></div>
    </header>

    <div class="screen">
      <canvas id="screen" width="256" height="240" style="width:768px;height:720px"></canvas>
    </div>

    <aside class="side">
      <div class="row">
        <input id="rom" type="file" accept=".nes,application/octet-stream" />
        <button id="btnRun" disabled>Run</button>
        <button id="btnPause" disabled>Pause</button>
        <button id="btnReset" disabled>Reset</button>
      </div>
      <div class="row stat">
        <div>ROM: <span id="romName">—</span></div>
      </div>
      <div class="grid2 stat">
        <div>FPS: <span id="fps">0</span></div>
        <div>CPU: <span id="mhz">—</span></div>
        <div>Mapper: <span id="mapper">—</span></div>
        <div>Mirroring: <span id="mirror">—</span></div>
        <div>IRQs: <span id="irqs">—</span></div>
      </div>

      <details>
        <summary>Controls</summary>
        <ul>
          <li>P1: <span class="kbd">Arrow Keys</span>, <span class="kbd">Z</span>=A, <span class="kbd">X</span>=B, <span class="kbd">Enter</span>=Start, <span class="kbd">Right Shift</span>=Select</li>
          <li>Touch: Mobile controls are visible on touch devices</li>
        </ul>
      </details>

      <details>
        <summary>Status / Notes</summary>
        <ul>
          <li>PPU: background + 8-sprites/scanline, priority, clipping, sprite-0 hit, NMI at vblank.</li>
          <li>APU: pulse 1/2, triangle, noise; DMC stub; basic frame sequencer & length/envelope (approx).</li>
          <li>Mappers: NROM (0), MMC1 (1 minimal), UxROM (2), CNROM (3), MMC3 (4 minimal, no IRQ).</li>
          <li>Accuracy: good for many early titles/homebrew; MMC3 IRQs not implemented yet → some games run without proper split-screen effects.</li>
        </ul>
      </details>

      <details>
        <summary>Roadmap toward Nestopia-like quality</summary>
        <ul>
          <li>Exact PPU open-bus, odd-frame cycle skip, precise timing on $2002/$2007 side effects.</li>
          <li>APU: proper resampler, DMC channel + IRQ, sweep/length counters edge cases.</li>
          <li>MMC3 scanline IRQ and A12 timing; more mappers (VRC, Sunsoft, etc.).</li>
        </ul>
      </details>
    </aside>
  </div>

  <!-- Overlay mask for hiding mobile controls -->
  <div class="mobile-controls-overlay-mask" id="mobileControlsMask">
    <button class="hide-mobile-btn" id="showMobileControlsBtn" type="button">Show Controls</button>
  </div>

  <!-- Mobile controls overlay -->
  <div class="mobile-controls" id="mobileControls" aria-hidden="true">
    <button class="hide-mobile-btn" id="hideMobileControlsBtn" type="button" style="top:10px;left:auto;right:10px;z-index:1002;">Hide Overlay</button>
    <div style="flex:1;">
      <div class="dpad">
        <div></div>
        <button class="mobile-btn" data-key="ArrowUp" aria-label="Up">&#8593;</button>
        <div></div>
        <button class="mobile-btn" data-key="ArrowLeft" aria-label="Left">&#8592;</button>
        <div></div>
        <button class="mobile-btn" data-key="ArrowRight" aria-label="Right">&#8594;</button>
        <div></div>
        <button class="mobile-btn" data-key="ArrowDown" aria-label="Down">&#8595;</button>
        <div></div>
      </div>
    </div>
    <div style="flex:1;display:flex;flex-direction:column;align-items:flex-end;justify-content:flex-end;gap:8px;">
      <div class="abpad">
        <button class="mobile-btn" data-key="KeyZ" aria-label="A">A</button>
        <button class="mobile-btn" data-key="KeyX" aria-label="B">B</button>
        <button class="mobile-btn" data-key="Enter" aria-label="Start">Start</button>
        <button class="mobile-btn" data-key="ShiftRight" aria-label="Select">Sel</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const BUILD = new Date().toISOString().replace('T',' ').slice(0,19);
  document.getElementById('build').textContent = `build ${BUILD}`;

  // ===== Utilities =====
  const clamp=(v,min,max)=>v<min?min:v>max?max:v;
  const u8 = n => n & 0xFF;
  const u16 = n => n & 0xFFFF;
  const toHex=(n,len=2)=>('0'.repeat(len)+n.toString(16).toUpperCase()).slice(-len);

  // ===== Controllers =====
  class Controllers{
    constructor(){
      this.state1=0; this.state2=0; this.latch=0; this.shift1=0; this.shift2=0;
      this.keyMap = { // bit order: A,B,Select,Start,Up,Down,Left,Right
        'KeyZ':0, 'KeyX':1, 'ShiftRight':2, 'Enter':3,
        'ArrowUp':4,'ArrowDown':5,'ArrowLeft':6,'ArrowRight':7,
      };
      this.bindKeys();
      this.mobileActive = false;
      this.initMobile();
    }
    bindKeys(){
      window.addEventListener('keydown',e=>{
        if(e.repeat) return;
        if(this.keyMap[e.code]!==undefined){
          this.state1 |= (1<<this.keyMap[e.code]);
          e.preventDefault();
        }
      });
      window.addEventListener('keyup',e=>{
        if(this.keyMap[e.code]!==undefined){
          this.state1 &= ~(1<<this.keyMap[e.code]);
          e.preventDefault();
        }
      });
    }
    write(v){ this.latch = v & 1; if(this.latch){ this.shift1=this.state1; this.shift2=this.state2; }}
    read1(){ const out = this.shift1 & 1; if(!this.latch) this.shift1 = (this.shift1>>>1)|0x80; return out; }
    read2(){ const out = this.shift2 & 1; if(!this.latch) this.shift2 = (this.shift2>>>1)|0x80; return out; }

    // === Mobile controls ===
    initMobile() {
      const mobileControls = document.getElementById('mobileControls');
      if (!mobileControls) return;

      // Detect mobile/touch
      const enableMobile = () => {
        mobileControls.classList.add('active');
        this.mobileActive = true;
      };
      const disableMobile = () => {
        mobileControls.classList.remove('active');
        this.mobileActive = false;
      };
      // Show controls on touch devices or on small screens
      if ('ontouchstart' in window || navigator.maxTouchPoints || window.innerWidth < 900) {
        enableMobile();
      }
      window.addEventListener('resize', ()=>{
        if(window.innerWidth < 900) enableMobile();
        else if(!('ontouchstart' in window || navigator.maxTouchPoints)) disableMobile();
      });

      // For each mobile button, simulate keydown/up
      const btns = mobileControls.querySelectorAll('.mobile-btn');
      for(const btn of btns) {
        const code = btn.dataset.key;
        const bit = this.keyMap[code];
        if(bit === undefined) continue;

        // Touch
        let isPressed = false;
        const press = e => {
          if(isPressed) return;
          isPressed = true;
          this.state1 |= (1<<bit);
          btn.classList.add('pressed');
          e.preventDefault();
        };
        const release = e => {
          isPressed = false;
          this.state1 &= ~(1<<bit);
          btn.classList.remove('pressed');
          e.preventDefault();
        };
        btn.addEventListener('touchstart', press, {passive:false});
        btn.addEventListener('touchend', release, {passive:false});
        btn.addEventListener('touchcancel', release, {passive:false});
        btn.addEventListener('mousedown', press);
        btn.addEventListener('mouseup', release);
        btn.addEventListener('mouseleave', release);
        // Prevent scrolling and double-tap zoom
        btn.addEventListener('contextmenu', e=>e.preventDefault());
      }

      // Prevent scrolling when interacting with controls
      mobileControls.addEventListener('touchmove', e=>{
        if(e.target.classList.contains('mobile-btn')) e.preventDefault();
      }, {passive:false});
    }
  }

  // ====== Overlay mask logic for mobile controls ======
  function setupMobileOverlayMask() {
    const mask = document.getElementById('mobileControlsMask');
    const mobileControls = document.getElementById('mobileControls');
    const hideBtn = document.getElementById('hideMobileControlsBtn');
    const showBtn = document.getElementById('showMobileControlsBtn');

    // Hide the controls and show the mask
    hideBtn.addEventListener('click', function(e) {
      e.preventDefault();
      mobileControls.classList.remove('active');
      mask.classList.add('active');
    });

    // Show the controls again
    showBtn.addEventListener('click', function(e) {
      e.preventDefault();
      mask.classList.remove('active');
      mobileControls.classList.add('active');
    });

    // Also allow clicking on mask (but not button) to dismiss mask and show controls
    mask.addEventListener('click', function(e) {
      // Only if not clicking the button itself
      if(e.target === mask) {
        mask.classList.remove('active');
        mobileControls.classList.add('active');
      }
    });

    // Optionally, show the overlay mask at init if on mobile/touch (do NOT do this automatically, only after user hides overlay)
    // Responsive: hide mask on desktop resize
    window.addEventListener('resize', ()=>{
      if(window.innerWidth >= 900 && mask.classList.contains('active')) {
        mask.classList.remove('active');
        mobileControls.classList.add('active');
      }
    });
  }

  // ===== APU (very simplified) =====
  // ... [no change, omitted for brevity] ...

  // ... [rest of JS code unchanged, omitted for brevity] ...

  // ===== UI glue =====
  const canvas = document.getElementById('screen');
  const nes = new NES(canvas);
  const romInput = document.getElementById('rom');
  const btnRun = document.getElementById('btnRun');
  const btnPause = document.getElementById('btnPause');
  const btnReset = document.getElementById('btnReset');
  const romName = document.getElementById('romName');

  romInput.addEventListener('change', async (e)=>{
    const f=e.target.files[0]; if(!f) return; romName.textContent=f.name;
    const buf = new Uint8Array(await f.arrayBuffer());
    try {
      nes.loadROM(buf); btnRun.disabled=false; btnPause.disabled=false; btnReset.disabled=false;
    } catch(err){ alert('ROM load failed: '+err.message); btnRun.disabled=true; btnPause.disabled=true; btnReset.disabled=true; }
  });

  btnRun.addEventListener('click',()=>nes.run());
  btnPause.addEventListener('click',()=>nes.pause());
  btnReset.addEventListener('click',()=>nes.reset());

  // Prevent scrolling/touchmove on body and document
  window.addEventListener('touchmove', function(e){ e.preventDefault(); }, {passive:false});
  window.addEventListener('scroll', function(){ window.scrollTo(0,0); }, {passive:false});
  document.body.addEventListener('wheel', function(e){ e.preventDefault(); }, {passive:false});

  // Setup the mask/hide/show overlay feature for mobile controls
  setupMobileOverlayMask();

})();
</script>
</body>
</html>
