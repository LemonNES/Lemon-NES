<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>NES ROM with Text</title>
</head>
<body>
  <h1>NES ROM Generator</h1>
  <button id="build">Build hello-text.nes</button>

  <script>
  function buildNES() {
    // --- iNES header ---
    const header = new Uint8Array([
      0x4E,0x45,0x53,0x1A, // "NES"
      0x01, // 1x16KB PRG
      0x01, // 1x8KB CHR
      0x00,0x00, // flags
      0,0,0,0,0,0,0,0 // padding
    ]);

    // --- PRG ROM (16KB) ---
    const prg = new Uint8Array(0x4000);
    let i = 0;
    function emit(...bytes){ for (let b of bytes) prg[i++] = b; }

    // Reset routine
    emit(0x78); // SEI
    emit(0xD8); // CLD
    emit(0xA2,0x40); emit(0x9A); // LDX #$40, TXS
    // wait vblank
    emit(0xAD,0x02,0x20); emit(0x10,0xFB);
    // PPUADDR=$2000
    emit(0xA9,0x20); emit(0x8D,0x06,0x20);
    emit(0xA9,0x00); emit(0x8D,0x06,0x20);
    // Write HELLO (1,2,3,3,4)
    for (let t of [1,2,3,3,4]) {
      emit(0xA9,t); emit(0x8D,0x07,0x20);
    }
    // Enable background
    emit(0xA9,0x08); emit(0x8D,0x00,0x20);
    emit(0xA9,0x1E); emit(0x8D,0x01,0x20);
    // Loop
    emit(0x4C, i&0xFF, (0x80 + (i>>8))&0xFF);

    // Vectors
    prg[0x3FFA]=0x00; prg[0x3FFB]=0x80;
    prg[0x3FFC]=0x00; prg[0x3FFD]=0x80;
    prg[0x3FFE]=0x00; prg[0x3FFF]=0x80;

    // --- CHR (simple font) ---
    const chr = new Uint8Array(0x2000);
    function setTile(tileIndex, pattern){
      let base = tileIndex*16;
      for (let y=0;y<8;y++){
        let row = pattern[y]||0;
        chr[base+y] = row; // plane 0 only
      }
    }
    // crude tiles
    setTile(1,[0x92,0x92,0xFE,0x92,0x92,0x92,0,0]); // H
    setTile(2,[0xFE,0x80,0xF8,0x80,0xFE,0,0,0]);    // E
    setTile(3,[0x80,0x80,0x80,0x80,0xFE,0,0,0]);    // L
    setTile(4,[0x7C,0x82,0x82,0x82,0x7C,0,0,0]);    // O

    // --- Combine ---
    const rom = new Uint8Array(header.length+prg.length+chr.length);
    rom.set(header,0);
    rom.set(prg,header.length);
    rom.set(chr,header.length+prg.length);

    // --- Download ---
    const blob = new Blob([rom], {type:"application/octet-stream"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "hello-text.nes";
    document.body.appendChild(a);   // <-- append to DOM
    a.click();                      // trigger click
    document.body.removeChild(a);   // cleanup
    URL.revokeObjectURL(url);
  }

  document.getElementById("build").addEventListener("click", buildNES);
  </script>
</body>
</html>
